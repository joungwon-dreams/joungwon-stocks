# AI Analysis Caching & Fallback Specification

## 1. Overview
To resolve Gemini API rate limit (429) issues and improve report generation stability, we will implement a **Database Caching Layer** and a **Rule-Based Fallback Mechanism**.

## 2. Caching Strategy (Smart Reuse)

### 2.1 Logic Flow
When `PortfolioAdvisor.generate_strategy(stock_code)` is called:

1.  **DB Check:** Query `portfolio_ai_history` table.
    ```sql
    SELECT recommendation, rationale 
    FROM portfolio_ai_history 
    WHERE stock_code = :code AND report_date = CURRENT_DATE
    ```
2.  **Cache Hit:** If a record exists, return the saved data immediately. (API Cost: 0)
3.  **Cache Miss:** Call Gemini API.
    - **Success:** Save result to DB and return it.
    - **Failure (429/Error):** Trigger **Fallback Mechanism**.

## 3. Rule-Based Fallback (Safety Net)

If API fails, generate a strategy based on hard-coded quantitative rules instead of returning "Error" or "Hold" blindly.

### 3.1 Logic Matrix

| Condition (Profit Rate) | Condition (Supply/Trend) | Decision | Rationale Template |
| :--- | :--- | :--- | :--- |
| **Deep Loss (< -10%)** | Foreigner Buying | **BUY MORE** | "낙폭 과대 구간에서 외국인 수급이 유입되고 있어 분할 매수 기회로 보입니다." |
| **Deep Loss (< -10%)** | Selling | **HOLD** | "하락세가 지속되고 있어 바닥 확인 전까지 관망을 권장합니다." |
| **Profit (> +10%)** | - | **SELL** | "목표 수익률 도달 가능성이 높으므로 부분 이익 실현을 고려하세요." |
| **Minor Fluctuation** | Golden Cross | **BUY** | "기술적 지표(골든크로스)가 상승 반전을 암시합니다." |
| **Default** | - | **HOLD** | "특이 사항이 없어 현 추세를 관망합니다." |

### 3.2 Implementation
The `rationale` string must append a footer:  
`*(Note: AI quota exceeded. Strategy generated by quantitative rules.)*`

## 4. Database Schema (Review)

Ensure `portfolio_ai_history` table has unique constraint or index for efficient lookups.
```sql
CREATE UNIQUE INDEX IF NOT EXISTS idx_pf_history_unique 
ON portfolio_ai_history (stock_code, report_date);
```

## 5. Implementation Tasks

1.  **Modify `scripts/gemini/components/portfolio_advisor.py`**:
    - Add `check_cache()` method.
    - Add `generate_fallback_strategy()` method.
    - Update `generate_strategy()` to use both.

2.  **Update `generate_pdf_report.py`**:
    - Ensure it handles the "Cached" or "Fallback" status gracefully (logging).
