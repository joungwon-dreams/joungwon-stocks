---
created: 2025-11-27 14:08:02
updated: 2025-11-27 14:08:02
tags: [changelog, feature, 신규종목추천, ai, gemini]
author: wonny
status: active
---

# 2025-11-27 신규종목추천 시스템 구현

## 개요

AI 기반 신규 투자 종목 발굴 시스템 완성. 4단계 파이프라인으로 2,700개 전체 종목에서 S등급 32개 종목 발굴 성공.

## 변경 사항

### 신규 파일

```
신규종목추천/
├── run.py                     # 메인 실행
├── config/settings.py         # 설정 관리
└── src/
    ├── utils/database.py      # DB 연결
    ├── phase1/
    │   ├── filter_phase1a.py  # SQL 필터
    │   └── filter_phase1b.py  # 기술적 필터
    ├── phase2/
    │   ├── batch_collector.py # 데이터 수집
    │   └── gemini_analyzer.py # AI 분석
    └── phase3/scorer.py       # 스코어링
```

### 데이터 수집 스크립트

```
scripts/
├── collect_fundamentals_pykrx.py  # PBR/PER 수집
├── collect_ohlcv_fdr.py           # OHLCV 수집 (FDR)
├── collect_ohlcv_simple.py        # OHLCV (pykrx 단순)
└── collect_ohlcv_batch.py         # OHLCV (배치)
```

### 문서

```
docs/
├── 신규종목추천-시스템-설계.md    # 상세 설계 문서
신규종목추천/
└── README.md                      # 사용 가이드
```

## 시스템 아키텍처

```
Phase 1A (SQL필터) → Phase 1B (기술분석) → Phase 2 (AI분석) → Phase 3 (스코어링)
   2700개             200개              100개             100개
```

### Phase 1A: SQL 기반 필터

- PBR: 0.1 ~ 3.0
- PER: 1.0 ~ 30.0
- 거래량: > 10,000
- 보유 종목 제외

### Phase 1B: 기술적 지표 필터

- RSI(14): 20 ~ 80
- 이격도(20일): <= 115%
- 이격도(60일): <= 120%
- 정량 점수 산출

### Phase 2: Gemini AI 분석

- 모델: gemini-2.0-flash
- 배치: 5개 종목/호출
- 등급: S/A/B/C/D

### Phase 3: 스코어링

- 최종점수 = 정량(40%) + 정성(60%)
- 마크다운 리포트 생성

## 결과

### 성능

| 단계 | 소요 시간 |
|:---|:---|
| Phase 1A | ~2초 |
| Phase 1B | ~0.5초 |
| Phase 2A | ~3분 |
| Phase 2B | ~5분 |
| Phase 3 | ~0.1초 |
| **총합** | **~8분** |

### 등급 분포 (100개 분석 결과)

| 등급 | 종목 수 | 비율 |
|:---:|:---:|:---:|
| S | 32 | 32% |
| A | 27 | 27% |
| B | 23 | 23% |
| C | 17 | 17% |
| D | 1 | 1% |

### Top 5 S등급 종목

1. **유성티엔에스** (PBR 0.16, PER 1.32) - 69.6점
2. **인터지스** (PBR 0.25, PER 4.97) - 69.0점
3. **삼천리** (PBR 0.26, PER 4.08) - 68.9점
4. **윈하이텍** (PBR 0.29, PER 2.89) - 68.7점
5. **송원산업** (PBR 0.29, PER 4.83) - 68.7점

## 해결한 문제

### 1. PBR/PER 데이터 부족

**문제**: stock_fundamentals 테이블에 18개 종목만 존재

**해결**: pykrx로 전체 종목 fundamental 데이터 수집
```bash
python scripts/collect_fundamentals_pykrx.py
# 결과: 2,718개 종목 수집
```

### 2. OHLCV 데이터 부족

**문제**: daily_ohlcv 테이블에 10개 종목만 존재

**해결**: FinanceDataReader로 전체 종목 OHLCV 수집
```bash
python scripts/collect_ohlcv_fdr.py
# 결과: 106,181개 레코드 수집
```

### 3. S등급 미발견

**문제**: 초기 실행에서 S등급 0개

**원인**: Gemini 프롬프트가 너무 보수적

**해결**: 등급 기준 완화
```
# Before
S등급: 정책 수혜 + 실적 턴어라운드 + 저평가 (3가지 모두 충족)

# After
S등급: PBR 0.3 이하 AND PER 5 이하
```

### 4. FK 제약 위반

**문제**: `stock_code '0093G0' is not present in table 'stocks'`

**해결**: stocks 테이블에 존재하는 종목만 필터링

### 5. Date 타입 오류

**문제**: asyncpg에서 문자열 날짜 처리 실패

**해결**: pandas timestamp를 date 객체로 변환
```python
if hasattr(date_idx, 'date'):
    date_val = date_idx.date()
```

## 실행 방법

```bash
# 데이터 수집 (최초 1회)
python scripts/collect_fundamentals_pykrx.py
python scripts/collect_ohlcv_fdr.py

# 추천 실행
python 신규종목추천/run.py
```

## 관련 문서

- [[../features/신규종목추천-기능]]
- [[../troubleshooting/신규종목추천-오류]]

## 향후 계획

- [ ] 수급 데이터 연동
- [ ] 뉴스 감성 분석 강화
- [ ] 백테스트 구현
- [ ] 자동 매매 연동
