---
created: 2025-11-27 14:08:02
updated: 2025-11-27 14:08:02
tags: [troubleshooting, error, 신규종목추천]
author: wonny
status: active
severity: medium
---

# 신규종목추천 Troubleshooting

## 오류 목록

### 1. Phase 1A에서 종목이 너무 적게 선정됨

**발생 시점**: 2025-11-27
**심각도**: high
**관련 파일**: `신규종목추천/src/phase1/filter_phase1a.py`

#### 증상

```
Phase 1A 완료: 6개 종목 선정
```

예상보다 너무 적은 종목만 선정됨.

#### 원인 분석

`stock_fundamentals` 테이블에 PBR/PER 데이터가 거의 없음:

```sql
SELECT COUNT(*) FROM stock_fundamentals WHERE pbr IS NOT NULL;
-- 결과: 18
```

#### 해결 방법

pykrx로 전체 종목 fundamental 데이터 수집:

```bash
python scripts/collect_fundamentals_pykrx.py
```

#### 예방 방법

- 매일 장 마감 후 데이터 수집 스케줄링
- 데이터 수집 전 카운트 체크

---

### 2. Phase 1B RSI/이격도 계산 실패

**발생 시점**: 2025-11-27
**심각도**: high
**관련 파일**: `신규종목추천/src/phase1/filter_phase1b.py`

#### 증상

```
OHLCV 로드 완료: 0개 종목
```

또는

```
ValueError: cannot convert float NaN to integer
```

#### 원인 분석

`daily_ohlcv` 테이블에 최근 데이터가 없음:

```sql
SELECT COUNT(DISTINCT stock_code) FROM daily_ohlcv
WHERE date >= CURRENT_DATE - INTERVAL '5 days';
-- 결과: 10
```

#### 해결 방법

FinanceDataReader로 OHLCV 데이터 수집:

```bash
python scripts/collect_ohlcv_fdr.py
```

#### 예방 방법

- 데이터 수집 후 검증 쿼리 실행
- 최소 종목 수 체크 로직 추가

---

### 3. FK 제약 위반 오류

**발생 시점**: 2025-11-27
**심각도**: medium
**관련 파일**: `scripts/collect_fundamentals_pykrx.py`

#### 증상

```
asyncpg.exceptions.ForeignKeyViolationError: insert or update on table
"stock_fundamentals" violates foreign key constraint
Key (stock_code)=(0093G0) is not present in table "stocks"
```

#### 원인 분석

pykrx에서 가져온 종목 중 stocks 테이블에 없는 종목 존재 (우선주, ETF 등).

#### 해결 방법

stocks 테이블에 존재하는 종목만 필터링:

```python
existing_codes = await conn.fetch("SELECT stock_code FROM stocks")
existing_set = {r['stock_code'] for r in existing_codes}

for code in df.index:
    if code not in existing_set:
        continue  # 스킵
```

#### 예방 방법

- 데이터 수집 시 항상 마스터 테이블 기준으로 필터링
- JOIN 사용하여 안전하게 INSERT

---

### 4. Date 타입 오류

**발생 시점**: 2025-11-27
**심각도**: medium
**관련 파일**: `scripts/collect_ohlcv_fdr.py`

#### 증상

```
AttributeError: 'str' object has no attribute 'toordinal'
```

#### 원인 분석

asyncpg는 문자열 날짜를 직접 처리하지 못함. Python date 객체가 필요.

#### 해결 방법

pandas timestamp를 date 객체로 변환:

```python
for date_idx, row in df.iterrows():
    if hasattr(date_idx, 'date'):
        date_val = date_idx.date()
    else:
        date_val = datetime.strptime(str(date_idx)[:10], '%Y-%m-%d').date()
```

#### 예방 방법

- asyncpg 사용 시 항상 Python native 타입 사용
- 타입 검증 함수 추가

---

### 5. S등급 종목 0개

**발생 시점**: 2025-11-27
**심각도**: low
**관련 파일**: `신규종목추천/src/phase2/gemini_analyzer.py`

#### 증상

```
등급 분포:
S: 0 (0.0%)
A: 0 (0.0%)
B: 31 (62.0%)
```

#### 원인 분석

Gemini 프롬프트의 S등급 기준이 너무 엄격:

```
S등급: 정책 수혜 + 실적 턴어라운드 + 저평가 (3가지 모두 충족)
```

#### 해결 방법

프롬프트 기준 완화:

```python
# gemini_analyzer.py 프롬프트 수정
**등급 기준 (반드시 준수):**
- S등급: PBR 0.3 이하 AND PER 5 이하
- A등급: PBR 0.5 이하 OR PER 7 이하

**필수 S등급 부여 조건:**
- PBR 0.2 이하이고 PER 3 이하
- 정량 점수 36점 이상이고 PER 5 이하
```

#### 예방 방법

- 등급 기준을 명확한 수치로 제시
- "반드시" 등의 강조 표현 사용

---

### 6. Gemini API Rate Limit

**발생 시점**: 간헐적
**심각도**: low
**관련 파일**: `신규종목추천/src/phase2/gemini_analyzer.py`

#### 증상

```
google.api_core.exceptions.ResourceExhausted: 429 Resource has been exhausted
```

#### 원인 분석

Gemini API 호출 빈도가 제한 초과.

#### 해결 방법

Rate delay 증가:

```python
# config/settings.py
@dataclass
class Phase2BConfig:
    rate_delay_seconds: int = 15  # 10 → 15
```

#### 예방 방법

- 배치 사이즈 증가 (5 → 10)
- 호출 간격 증가 (10초 → 15초)

---

### 7. 보유 종목이 결과에 포함됨

**발생 시점**: 2025-11-27
**심각도**: medium
**관련 파일**: `신규종목추천/src/phase1/filter_phase1a.py`

#### 증상

결과에 이미 보유 중인 종목이 포함됨.

#### 원인 분석

stock_assets 테이블과 조인이 누락됨.

#### 해결 방법

SQL에 보유 종목 제외 조건 추가:

```sql
WHERE s.stock_code NOT IN (
    SELECT stock_code FROM stock_assets
    WHERE quantity > 0
)
```

#### 예방 방법

- Phase 1A 시작 시 보유 종목 목록 로깅
- 결과 검증 단계 추가

---

## 교훈 및 개선사항

### 데이터 의존성 체크

파이프라인 실행 전 필수 데이터 존재 여부 확인:

```python
async def validate_data_availability():
    fund_count = await db.fetchval(
        "SELECT COUNT(*) FROM stock_fundamentals WHERE pbr IS NOT NULL"
    )
    if fund_count < 100:
        raise ValueError(f"Fundamental data insufficient: {fund_count}")
```

### 타입 안전성

asyncpg와 pandas 간 타입 변환 주의:

```python
# 안전한 타입 변환 함수
def safe_date(val):
    if hasattr(val, 'date'):
        return val.date()
    if isinstance(val, str):
        return datetime.strptime(val[:10], '%Y-%m-%d').date()
    return val
```

### 프롬프트 엔지니어링

AI 등급 기준을 명확한 수치로:

```
# Bad
S등급: 매우 저평가된 종목

# Good
S등급: PBR 0.3 이하 AND PER 5 이하
```

---

## 관련 문서

- [[../changelog/2025-11-27-신규종목추천-시스템]]
- [[../features/신규종목추천-기능]]
